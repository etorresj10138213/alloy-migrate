name: 'CI/CD: Deploy Grafana Alloy to Istio/GKE'

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'config/config.alloy'    # Se activa al cambiar la configuraci칩n de Alloy
      - 'k8s/alloy-deployment.yaml' # Se activa al cambiar el Deployment de K8s
  workflow_dispatch:

jobs:
  validate_config:
    runs-on: ubuntu-latest
    env:
      NAMESPACE: istio-system
      PROMETHEUS_CONFIGMAP_NAME: prometheus-config
      CONFIG_KEY: prometheus.yml

    steps:
      # ... (Pasos de Checkout e Install Grafana Alloy sin cambios)
        
      - name: 游 Setup GKE Credentials (Authentication)
        # Usamos setup-gcloud para autenticar, pero NO exportamos las credenciales por defecto,
        # para evitar conflictos si get-gke-credentials no las lee bien.
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }} 
          # Eliminamos 'export_default_credentials: true'

      - name: 游꿢 Get GKE Kubeconfig (Connect to Cluster)
        # ESTA ES LA CORRECCI칍N CLAVE: Pasar la Service Account Key directamente
        # como fallback, forzando la autenticaci칩n para esta acci칩n espec칤fica.
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          location: ${{ secrets.GKE_ZONE }}
          # Inyectamos la clave directamente para asegurar la autenticaci칩n del cl칰ster
          credentials: ${{ secrets.GCP_SA_KEY }} 
          
      # ... (El resto del job validate_config sin cambios)

  deploy_alloy:
    needs: validate_config
    runs-on: ubuntu-latest
    environment: GKE-Production 
    
    steps:
      - name: 拘勇 Checkout code
        uses: actions/checkout@v4

      - name: 游 Setup GKE Credentials (Authentication)
        # Hacemos la autenticaci칩n del job (necesaria para kubectl apply)
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}

      - name: 游꿢 Get GKE Kubeconfig (Connect to Cluster)
        # Y tambi칠n aqu칤, usamos la clave directa
        uses: google-github-actions/get-gke-credentials@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE }}
          credentials: ${{ secrets.GCP_SA_KEY }} # Inyectamos la clave directa
             
      - name: 游 Apply Alloy Configuration and Deployment
        run: |
          # Nota: Aqu칤 se est치 usando el archivo 'config/config.alloy' que deber칤a haber sido 
          # previamente comprometido (commited) en el repositorio, ya que el paso de conversi칩n
          # en el job anterior solo crea el archivo localmente.
          
          echo "Desplegando Grafana Alloy en el namespace istio-system..."
          
          # 1. Crear/Actualizar ConfigMap
          # Usamos el namespace del Job anterior
          kubectl create configmap grafana-alloy-config -n istio-system --from-file=config.alloy=config/config.alloy --dry-run=client -o yaml | kubectl apply -f -
          
          # 2. Aplicar el Deployment (que montar치 el ConfigMap)
          kubectl apply -f k8s/alloy-deployment.yaml
          
          echo "Despliegue de Grafana Alloy completado. Ahora actualiza la fuente de datos en Grafana (istio-system)."