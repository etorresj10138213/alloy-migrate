name: 'CI/CD: Deploy Grafana Alloy to Istio/GKE'

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'config/config.alloy'    # Se activa al cambiar la configuraci贸n de Alloy
      - 'k8s/alloy-deployment.yaml' # Se activa al cambiar el Deployment de K8s
  workflow_dispatch:

jobs:
  validate_config:
    runs-on: ubuntu-latest
    env:
      NAMESPACE: istio-system
      PROMETHEUS_CONFIGMAP_NAME: prometheus-config
      CONFIG_KEY: prometheus.yml
      # Mover PROJECT_ID, CLUSTER y ZONE a secrets, o usarlos consistentemente.
      # Usaremos los secrets directamente en los pasos para evitar ambig眉edad.

    steps:
      - name: 猬锔 Checkout code
        uses: actions/checkout@v4
        
      - name: 锔 Install Grafana Alloy Binaries (ZIP)
        id: install_alloy
        run: |
          # --- Variables de la URL proporcionada ---
          ALLOY_VERSION="v1.11.3"
          FILENAME="alloy-linux-amd64.zip"
          ALLOY_URL="https://github.com/grafana/alloy/releases/download/${ALLOY_VERSION}/${FILENAME}"
          
          echo "Intentando descargar Grafana Alloy ${ALLOY_VERSION}..."
          
          curl -sL --fail -o ${FILENAME} ${ALLOY_URL}
          if [ $? -ne 0 ]; then
            echo "Error: Fallo al descargar el archivo desde la URL. Verifica la versi贸n y la URL."
            exit 1
          fi
          
          sudo apt-get update && sudo apt-get install -y unzip
          unzip ${FILENAME}
          
          if [ -f alloy-linux-amd64 ]; then
            # Renombrado y movido a /usr/local/bin
            sudo mv alloy-linux-amd64 /usr/local/bin/alloy
            sudo chmod +x /usr/local/bin/alloy # Usar +x en lugar de 777
          else
            echo "Error: No se encontr贸 el binario 'alloy' desempaquetado. Verifique el contenido del ZIP."
            exit 1
          fi

          alloy --version
          
      - name:  Setup GKE Credentials (Authentication)
        # ESTE PASO AUTENTICA EL AMBIENTE DE TRABAJO (gcloud auth)
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          # La clave del Service Account es CRUCIAL para autenticar
          service_account_key: ${{ secrets.GKE_SA_KEY }} 
          export_default_credentials: true # Esto es necesario para la siguiente acci贸n

      - name:  Get GKE Kubeconfig (Connect to Cluster)
        # ESTE PASO OBTIENE LAS CREDENCIALES DEL CLSTER (kubectl config)
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          location: ${{ secrets.GKE_ZONE }}
          
      - name:  Extract Prometheus Config from GKE ConfigMap
        id: extract
        run: |
          echo "Extrayendo configuraci贸n de Prometheus de ConfigMap: ${PROMETHEUS_CONFIGMAP_NAME}..."
          
          kubectl get configmap ${PROMETHEUS_CONFIGMAP_NAME} -n ${NAMESPACE} -o jsonpath="{.data.${CONFIG_KEY}}" > prometheus.yaml
          
          if [ ! -s prometheus.yaml ]; then
            echo "Error: El archivo prometheus.yaml est谩 vac铆o. El ConfigMap o la clave son incorrectos."
            exit 1
          fi
          echo "Configuraci贸n de Prometheus extra铆da con 茅xito."
          
      - name:  Convert Prometheus to Alloy & Validate
        id: convert_validate
        run: |
          # Usa el archivo extra铆do (prometheus.yaml como fuente
          echo "Realizando conversi贸n a config.alloy"
          alloy convert --source-format=prometheus --output=config.alloy prometheus.yaml
          
      - name: И Simulate Alloy Run (Dry Run)
        # Corregido: La validaci贸n es impl铆cita en 'alloy convert'. Usamos 'alloy validate' o un test
        run: |
          echo "Validando sintaxis de config.alloy..."
          /usr/local/bin/alloy validate config.alloy 
          
          echo "Simulando ejecuci贸n de Alloy (Dry Run)..."
          /usr/local/bin/alloy run config.alloy --dry-run
          echo "Simulaci贸n de ejecuci贸n exitosa."

  deploy_alloy:
    needs: validate_config
    runs-on: ubuntu-latest
    environment: GKE-Production 
    
    steps:
      - name: 猬锔 Checkout code
        uses: actions/checkout@v4

      - name:  Setup GKE Credentials (Authentication)
        # La autenticaci贸n se debe repetir en este job.
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GKE_SA_KEY }}
          export_default_credentials: true

      - name:  Get GKE Kubeconfig (Connect to Cluster)
        uses: google-github-actions/get-gke-credentials@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE }}
          
      - name:  Apply Alloy Configuration and Deployment
        run: |
          # Nota: Aqu铆 se est谩 usando el archivo 'config/config.alloy' que deber铆a haber sido 
          # previamente comprometido (commited) en el repositorio, ya que el paso de conversi贸n
          # en el job anterior solo crea el archivo localmente.
          
          echo "Desplegando Grafana Alloy en el namespace istio-system..."
          
          # 1. Crear/Actualizar ConfigMap
          # Usamos el namespace del Job anterior
          kubectl create configmap grafana-alloy-config -n istio-system --from-file=config.alloy=config/config.alloy --dry-run=client -o yaml | kubectl apply -f -
          
          # 2. Aplicar el Deployment (que montar谩 el ConfigMap)
          kubectl apply -f k8s/alloy-deployment.yaml
          
          echo "Despliegue de Grafana Alloy completado. Ahora actualiza la fuente de datos en Grafana (istio-system)."