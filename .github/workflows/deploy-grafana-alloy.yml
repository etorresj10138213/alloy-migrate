name: CI/CD-Deploy Grafana Alloy to Istio/GKE

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  NAMESPACE: istio-system
  PROMETHEUS_CONFIGMAP_NAME: prometheus # Nombre de tu ConfigMap actual de Prometheus
  CONFIG_KEY: prometheus.yml

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Autenticaci贸n en Google Cloud
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }} # Clave de la Cuenta de Servicio (secreta)
          
      # 2. Configuraci贸n de GKE
      - name: Configurar gcloud y kubectl
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          # Asegura que las credenciales est茅n disponibles para Docker y kubectl
          setup_gcloud: true 

      # 2. Obtener Credenciales de GKE
      - name: Obtener credenciales del cluster GKE
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: 锔 Install Grafana Alloy Binaries (ZIP)
        id: install_alloy
        run: |
          # --- Variables de la URL proporcionada ---
          ALLOY_VERSION="v1.11.3"
          FILENAME="alloy-linux-amd64.zip"
          ALLOY_URL="https://github.com/grafana/alloy/releases/download/${ALLOY_VERSION}/${FILENAME}"
          
          echo "Intentando descargar Grafana Alloy ${ALLOY_VERSION}..."
          
          # Descarga el archivo ZIP, falla si el servidor devuelve un error
          # --fail asegura que falle si la URL es incorrecta
          curl -sL --fail -o ${FILENAME} ${ALLOY_URL}
          
          if [ $? -ne 0 ]; then
            echo "Error: Fallo al descargar el archivo desde la URL. Verifica la versi贸n y la URL."
            exit 1
          fi
          
          # Instalar unzip si no est谩 presente (necesario para manejar archivos .zip)
          echo "Instalando unzip..."
          sudo apt-get update && sudo apt-get install -y unzip
          
          # Descomprimir el archivo ZIP
          echo "Descomprimiendo el binario..."
          unzip ${FILENAME}
          
          # Mover el binario 'alloy' al PATH
          if [ -f alloy-linux-amd64 ]; then
            sudo mv alloy-linux-amd64 /usr/local/bin/alloy
            chmod 777 /usr/local/bin/alloy
          else
            echo "Error: No se encontr贸 el binario 'alloy' desempaquetado. Verifique el contenido del ZIP."
            exit 1
          fi

          # Verificar la instalaci贸n final
          alloy --version
          
          
      - name:  Extract Prometheus Config from GKE ConfigMap
        id: extract
        run: |
          echo "Extrayendo configuraci贸n de Prometheus de ConfigMap: ${PROMETHEUS_CONFIGMAP_NAME}..."
          
          # Usa kubectl para obtener el ConfigMap, extrae la clave del YAML (-o jsonpath)
          # y guarda el contenido en el archivo prometheus.yaml
          kubectl get configmap ${PROMETHEUS_CONFIGMAP_NAME} -n ${NAMESPACE} -o jsonpath="{.data.${CONFIG_KEY}}" > prometheus.yaml
          
          # Verifica que el archivo no est茅 vac铆o (indicando una extracci贸n exitosa)
          if [ ! -s prometheus.yaml ]; then
            echo "Error: El archivo prometheus.yaml est谩 vac铆o. El ConfigMap o la clave son incorrectos."
            exit 1
          fi
          echo "Configuraci贸n de Prometheus extra铆da con 茅xito."
          
      - name:  Convert Prometheus to Alloy & Validate
        id: convert_validate
        run: |
          # Usa el archivo extra铆do (prometheus.yaml como fuente
          echo "Realizando conversi贸n a config.alloy"
          alloy convert --source-format=prometheus --output=config.alloy prometheus.yaml          
      - name: И Simulate Alloy Run (Dry Run)
        if: success() && steps.validate.outcome == 'success'
        run: |
          echo "Simulando ejecuci贸n de Alloy (Dry Run)..."
          # Comando clave: Intenta inicializar todos los componentes sin conectarse a la red.
          alloy run config.alloy --dry-run
          echo "Simulaci贸n de ejecuci贸n exitosa."
      
      # 7. Despliegue a GKE 
      - name:  Apply Alloy Configuration and Deployment
        run: |
          echo "Desplegando Grafana Alloy en el namespace ${NAMESPACE}..."
          
          # 1. Crear/Actualizar ConfigMap
          kubectl create configmap grafana-alloy-config -n ${NAMESPACE} --from-file=config.alloy=config/config.alloy --dry-run=client -o yaml | kubectl apply -f -
          
          # 2. Aplicar el Deployment (que montar谩 el ConfigMap)
          kubectl apply -f k8s/alloy-deployment.yaml
          
          echo "Despliegue de Grafana Alloy completado. Ahora actualiza la fuente de datos en Grafana (istio-system)."