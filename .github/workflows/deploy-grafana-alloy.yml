name: 'Deploy Grafana Alloy to Istio/GKE'

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'config/config.alloy'
      - 'k8s/alloy-deployment.yaml'
  workflow_dispatch:

jobs:
  validate_config:
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4
        
      - name: ‚öôÔ∏è Install Grafana Alloy Binaries (Corrected)
        id: install_alloy
        run: |
          # Define la versi√≥n a instalar
          ALLOY_VERSION="1.11.3" 
          OS="linux"
          ARCH="amd64"
          FILENAME="alloy-${OS}-${ARCH}.tar.gz"
          
          # URL exacta del binario de la release
          ALLOY_URL="https://github.com/grafana/alloy/archive/refs/tags/v${ALLOY_VERSION}.tar.gz"
          
          echo "Intentando descargar Grafana Alloy v${ALLOY_VERSION} desde ${ALLOY_URL}..."
          
          # Descarga el archivo, falla si el servidor devuelve un error (4xx/5xx)
          curl -sL --fail -o ${FILENAME} ${ALLOY_URL}
          
          # Verificar si curl fall√≥ (por ejemplo, si la URL no existe)
          if [ $? -ne 0 ]; then
            echo "Error: Fallo al descargar el archivo desde la URL. Verifica la versi√≥n y la URL."
            exit 1
          fi
          
          # Descomprime (el contenido es solo el archivo 'alloy' en la ra√≠z del tarball o en una carpeta)
          tar -xvf ${FILENAME}
          
          # Mover el binario al PATH. El nombre del archivo desempaquetado a veces es solo 'alloy'
          # Intentamos mover el archivo desempaquetado que coincide con el nombre del binario.
          if [ -f alloy ]; then
            sudo mv alloy /usr/local/bin/
          elif [ -d alloy-${OS}-${ARCH} ]; then
            sudo mv alloy-${OS}-${ARCH}/alloy /usr/local/bin/
          else
            echo "Error: No se encontr√≥ el binario de Alloy desempaquetado."
            exit 1
          fi

          # Verificar la instalaci√≥n final
          alloy --version
          
      - name: ‚úÖ Validate Alloy Configuration Syntax
        id: validate
        run: |
          if [ -f config/config.alloy ]; then
            echo "Validando sintaxis de config/config.alloy..."
            alloy validate config/config.alloy
            echo "La validaci√≥n de sintaxis fue exitosa."
          else
            echo "El archivo config/config.alloy es requerido y no fue encontrado."
            exit 1 
          fi
          
      - name: üß™ Simulate Alloy Run (Dry Run)
        if: success() && steps.validate.outcome == 'success'
        run: |
          echo "Simulando ejecuci√≥n de Alloy (Dry Run)..."
          alloy run config/config.alloy --dry-run
          echo "Simulaci√≥n de ejecuci√≥n exitosa."

  deploy_alloy:
    needs: validate_config
    runs-on: ubuntu-latest
    environment: GKE-Production   
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üîí Setup GKE Credentials
        # Reemplaza con tu m√©todo real de autenticaci√≥n GKE (ej. workloadi-identity)
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GKE_PROJECT }}
          service_account_key: ${{ secrets.GKE_SA_KEY }} # Usa un Secret de GitHub
          export_default_credentials: true

      - name: üéØ Get GKE Kubeconfig
        # Con√©ctate al cl√∫ster donde est√° Istio-System
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_CLUSTER_LOCATION }}
          
      - name: üöÄ Apply Alloy Configuration and Deployment
        # Aplica los manifiestos de Kubernetes
        run: |
          NAMESPACE="istio-system" # Define el namespace donde quieres desplegar Alloy (no istio-system)
          echo "Desplegando Grafana Alloy en el namespace ${NAMESPACE}..."
          
          # 1. Crear/Actualizar ConfigMap con la nueva config.alloy
          kubectl create configmap grafana-alloy-config -n ${NAMESPACE} --from-file=config.alloy=config/config.alloy --dry-run=client -o yaml | kubectl apply -f -
          
          # 2. Aplicar el Deployment (que montar√° el ConfigMap)
          kubectl apply -f k8s/alloy-deployment.yaml
          
          echo "Despliegue de Grafana Alloy iniciado. Verifica los pods y el sidecar de Istio."
